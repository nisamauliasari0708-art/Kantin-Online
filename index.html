<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kantin Digital - SMAN 1 DRAMAGA</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Menggunakan font Inter bawaan Tailwind */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Menyembunyikan view/halaman secara default */
        .view {
            display: none;
        }
        /* Menampilkan view yang aktif */
        .view.active {
            display: block;
        }
        /* Helper class untuk transisi */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Kontainer Utama Aplikasi -->
    <div id="app" class="max-w-5xl mx-auto p-4 md:p-6 min-h-screen">

        <!-- 1. Halaman Login -->
        <div id="loginView" class="view active">
            <div class="bg-white p-8 rounded-lg shadow-xl max-w-md mx-auto mt-12 fade-in">
                <h1 class="text-3xl font-bold text-center text-blue-700 mb-2">SMAN 1 DRAMAGA</h1>
                <h2 class="text-xl text-center text-gray-600 mb-6">Kantin Digital</h2>
                
                <form id="loginForm">
                    <div class="mb-4">
                        <label for="loginUsername" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="loginUsername" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="loginPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="loginRole" class="block text-sm font-medium text-gray-700 mb-1">Login Sebagai</label>
                        <select id="loginRole" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="Siswa">Siswa</option>
                            <option value="Guru">Guru</option>
                            <option value="Penjual">Penjual</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                    <p id="loginError" class="text-red-500 text-sm mb-4 hidden"></p>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2.5 px-4 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 shadow-md">
                        Login
                    </button>
                </form>
                <p class="text-center text-sm text-gray-600 mt-6">
                    Belum punya akun? 
                    <button id="showRegisterBtn" class="font-medium text-blue-600 hover:text-blue-500">
                        Daftar di sini
                    </button>
                </p>
            </div>
        </div>

        <!-- 2. Halaman Pendaftaran -->
        <div id="registerView" class="view">
            <div class="bg-white p-8 rounded-lg shadow-xl max-w-md mx-auto mt-12 fade-in">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Pendaftaran Akun Baru</h2>
                
                <form id="registerForm">
                    <div class="mb-4">
                        <label for="registerUsername" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="registerUsername" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="registerPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="registerPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="registerRole" class="block text-sm font-medium text-gray-700 mb-1">Daftar Sebagai</label>
                        <select id="registerRole" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="Siswa">Siswa</option>
                            <option value="Guru">Guru</option>
                            <option value="Penjual">Penjual</option>
                        </select>
                    </div>
                    
                    <!-- Input Spesifik Peran -->
                    <div id="siswaFields" class="mb-4">
                        <label for="registerKelas" class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                        <select id="registerKelas" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <!-- Opsi Kelas akan di-generate oleh JS -->
                        </select>
                    </div>
                    <div id="penjualFields" class="mb-4 hidden">
                        <label for="registerNamaWarung" class="block text-sm font-medium text-gray-700 mb-1">Nama Warung/Toko</label>
                        <input type="text" id="registerNamaWarung" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <p id="registerError" class="text-red-500 text-sm mb-4 hidden"></p>
                    <button type="submit" class="w-full bg-green-600 text-white py-2.5 px-4 rounded-lg font-semibold hover:bg-green-700 transition duration-200 shadow-md">
                        Daftar
                    </button>
                </form>
                <p class="text-center text-sm text-gray-600 mt-6">
                    Sudah punya akun? 
                    <button id="showLoginBtn" class="font-medium text-blue-600 hover:text-blue-500">
                        Login di sini
                    </button>
                </p>
            </div>
        </div>

        <!-- 3. Wrapper Dashboard (Kontainer untuk semua dashboard setelah login) -->
        <div id="dashboardWrapper" class="view">
            <!-- Header/Navbar Umum Dashboard -->
            <header class="bg-white p-4 rounded-lg shadow-md mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-blue-700">Kantin SMAN 1 DRAMAGA</h1>
                    <p class="text-gray-600">Selamat datang, <span id="currentUserName" class="font-semibold"></span>!</p>
                </div>
                <button id="logoutBtn" class="bg-red-500 text-white py-2 px-5 rounded-lg font-medium hover:bg-red-600 transition duration-200">
                    Logout
                </button>
            </header>

            <!-- Konten Dashboard Spesifik (Admin, Siswa, Guru, Penjual) -->
            <main id="dashboardContent" class="fade-in">
                <!-- A. Dashboard Admin -->
                <div id="adminDashboard" class="dashboard-panel hidden">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Dashboard Admin</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Mengelola Penjual -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 border-b pb-2">Kelola Penjual</h3>
                            <form id="adminAddSellerForm" class="mb-4">
                                <label class="block text-sm font-medium">Tambah Penjual (dari User Terdaftar)</label>
                                <select id="adminSelectUser" class="w-full p-2 border rounded mt-1 mb-2"></select>
                                <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">Jadikan Penjual</button>
                            </form>
                            <div id="adminSellerList" class="space-y-2">
                                <!-- Daftar Penjual akan di-render di sini -->
                            </div>
                        </div>
                        
                        <!-- Rekap Pesanan (Sederhana) -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 border-b pb-2">Rekap Pesanan Global</h3>
                            <div id="adminOrderList" class="space-y-3 max-h-96 overflow-y-auto">
                                <!-- Daftar Pesanan akan di-render di sini -->
                            </div>
                        </div>
                    </div>

                    <!-- KELOLA MENU (BARU) -->
                    <div class="bg-white p-6 rounded-lg shadow-md mt-6">
                        <h3 class="text-lg font-semibold mb-4 border-b pb-2">Kelola Semua Menu</h3>
                        <div id="adminMenuList" class="space-y-3 max-h-96 overflow-y-auto">
                            <!-- Daftar Menu Global akan di-render di sini -->
                        </div>
                    </div>
                </div>

                <!-- B. Dashboard Siswa -->
                <div id="siswaDashboard" class="dashboard-panel hidden">
                    <!-- Navigasi Siswa -->
                    <nav class="bg-white rounded-lg shadow-md p-3 mb-6 flex justify-center space-x-2 md:space-x-4">
                        <button class="siswa-nav-btn py-2 px-4 rounded-lg font-medium text-blue-600 bg-blue-100" data-target="siswaMenuView">Lihat Menu</button>
                        <button class="siswa-nav-btn py-2 px-4 rounded-lg font-medium text-gray-600 hover:bg-gray-100" data-target="siswaPromoView">Lihat Promo</button>
                        <button class="siswa-nav-btn py-2 px-4 rounded-lg font-medium text-gray-600 hover:bg-gray-100" data-target="siswaCartView">
                            Keranjang (<span id="cartCount">0</span>)
                        </button>
                        <button class="siswa-nav-btn py-2 px-4 rounded-lg font-medium text-gray-600 hover:bg-gray-100" data-target="siswaHistoryView">Riwayat Pesanan</button>
                    </nav>

                    <!-- Konten Tab Siswa -->
                    <div id="siswaMenuView" class="siswa-tab-content">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Menu Kantin</h2>
                        <!-- Filter -->
                        <div class="flex space-x-2 mb-4">
                            <button class="menu-filter-btn bg-green-500 text-white py-1 px-4 rounded-full" data-category="Semua">Semua</button>
                            <button class="menu-filter-btn bg-gray-200 text-gray-700 py-1 px-4 rounded-full" data-category="Makanan">Makanan</button>
                            <button class="menu-filter-btn bg-gray-200 text-gray-700 py-1 px-4 rounded-full" data-category="Minuman">Minuman</button>
                            <button class="menu-filter-btn bg-gray-200 text-gray-700 py-1 px-4 rounded-full" data-category="Snack">Snack</button>
                        </div>
                        <!-- Daftar Menu -->
                        <div id="siswaMenuList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            <!-- Kartu Menu akan di-render di sini -->
                        </div>
                    </div>

                    <div id="siswaPromoView" class="siswa-tab-content hidden bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Promo Hari Ini</h2>
                        <div id="siswaPromoList" class="space-y-4">
                            <!-- Daftar Promo akan di-render di sini -->
                        </div>
                    </div>

                    <div id="siswaCartView" class="siswa-tab-content hidden bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Keranjang Belanja</h2>
                        <div id="cartItemsList" class="space-y-3 mb-4">
                            <!-- Item Keranjang akan di-render di sini -->
                        </div>
                        <div class="border-t pt-4">
                            <h3 class="text-xl font-semibold text-right mb-4">Total: <span id="cartTotal">Rp 0</span></h3>
                            <button id="checkoutBtn" class="w-full bg-green-600 text-white py-2.5 px-4 rounded-lg font-semibold hover:bg-green-700 transition duration-200">
                                Checkout Sekarang
                            </button>
                        </div>
                    </div>
                    
                    <div id="siswaHistoryView" class="siswa-tab-content hidden bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Riwayat Pesanan Saya</h2>
                        <div id="siswaOrderHistory" class="space-y-4">
                            <!-- Riwayat Pesanan akan di-render di sini -->
                        </div>
                    </div>
                </div>

                <!-- C. Dashboard Guru (Sama seperti siswa, tapi bisa disederhanakan jika perlu) -->
                <div id="guruDashboard" class="dashboard-panel hidden">
                    <!-- Navigasi Guru -->
                    <nav class="bg-white rounded-lg shadow-md p-3 mb-6 flex justify-center space-x-2 md:space-x-4">
                        <button class="guru-nav-btn py-2 px-4 rounded-lg font-medium text-blue-600 bg-blue-100" data-target="guruMenuView">Lihat Menu</button>
                        <button class="guru-nav-btn py-2 px-4 rounded-lg font-medium text-gray-600 hover:bg-gray-100" data-target="guruCartView">
                            Keranjang (<span id="guruCartCount">0</span>)
                        </button>
                        <button class="guru-nav-btn py-2 px-4 rounded-lg font-medium text-gray-600 hover:bg-gray-100" data-target="guruHistoryView">Riwayat Pembelian</button>
                    </nav>

                    <!-- Konten Tab Guru -->
                    <div id="guruMenuView" class="guru-tab-content">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Menu Kantin</h2>
                        <!-- Filter (BARU UNTUK GURU) -->
                        <div class="flex space-x-2 mb-4">
                            <button class="guru-menu-filter-btn bg-green-500 text-white py-1 px-4 rounded-full" data-category="Semua">Semua</button>
                            <button class="guru-menu-filter-btn bg-gray-200 text-gray-700 py-1 px-4 rounded-full" data-category="Makanan">Makanan</button>
                            <button class="guru-menu-filter-btn bg-gray-200 text-gray-700 py-1 px-4 rounded-full" data-category="Minuman">Minuman</button>
                            <button class="guru-menu-filter-btn bg-gray-200 text-gray-700 py-1 px-4 rounded-full" data-category="Snack">Snack</button>
                        </div>
                        <!-- Daftar Menu -->
                        <div id="guruMenuList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            <!-- Kartu Menu akan di-render di sini -->
                        </div>
                    </div>

                    <div id="guruCartView" class="guru-tab-content hidden bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Keranjang Belanja</h2>
                        <div id="guruCartItemsList" class="space-y-3 mb-4"></div>
                        <div class="border-t pt-4">
                            <h3 class="text-xl font-semibold text-right mb-4">Total: <span id="guruCartTotal">Rp 0</span></h3>
                            <button id="guruCheckoutBtn" class="w-full bg-green-600 text-white py-2.5 px-4 rounded-lg font-semibold hover:bg-green-700 transition duration-200">
                                Checkout Sekarang
                            </button>
                        </div>
                    </div>
                    
                    <div id="guruHistoryView" class="guru-tab-content hidden bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Riwayat Pembelian</h2>
                        <div id="guruOrderHistory" class="space-y-4"></div>
                    </div>
                </div>

                <!-- D. Dashboard Penjual -->
                <div id="penjualDashboard" class="dashboard-panel hidden">
                    <nav class="bg-white rounded-lg shadow-md p-3 mb-6 flex justify-center space-x-2 md:space-x-4">
                        <button class="penjual-nav-btn py-2 px-4 rounded-lg font-medium text-blue-600 bg-blue-100" data-target="penjualOrderView">Pesanan Masuk</button>
                        <button class="penjual-nav-btn py-2 px-4 rounded-lg font-medium text-gray-600 hover:bg-gray-100" data-target="penjualMenuView">Kelola Menu</button>
                        <button class="penjual-nav-btn py-2 px-4 rounded-lg font-medium text-gray-600 hover:bg-gray-100" data-target="penjualReportView">Laporan</button>
                    </nav>

                    <!-- Tab Pesanan Masuk -->
                    <div id="penjualOrderView" class="penjual-tab-content bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Pesanan Masuk</h2>
                        <div id="penjualOrderList" class="space-y-4">
                            <!-- Daftar Pesanan Masuk akan di-render di sini -->
                        </div>
                    </div>
                    
                    <!-- Tab Kelola Menu -->
                    <div id="penjualMenuView" class="penjual-tab-content hidden bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Kelola Menu Saya</h2>
                        <!-- Form Tambah/Edit Menu -->
                        <form id="menuForm" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 border rounded-lg bg-gray-50">
                            <input type="hidden" id="menuId">
                            <div>
                                <label for="menuName" class="block text-sm font-medium">Nama Menu</label>
                                <input type="text" id="menuName" class="w-full p-2 border rounded mt-1" required>
                            </div>
                            <div>
                                <label for="menuPrice" class="block text-sm font-medium">Harga (Rp)</label>
                                <input type="number" id="menuPrice" class="w-full p-2 border rounded mt-1" required>
                            </div>
                            <div>
                                <label for="menuStock" class="block text-sm font-medium">Stok</label>
                                <input type="number" id="menuStock" class="w-full p-2 border rounded mt-1" required>
                            </div>
                            <div>
                                <label for="menuCategory" class="block text-sm font-medium">Kategori</label>
                                <select id="menuCategory" class="w-full p-2 border rounded mt-1 bg-white">
                                    <option value="Makanan">Makanan</option>
                                    <option value="Minuman">Minuman</option>
                                    <option value="Snack">Snack</option>
                                </select>
                            </div>
                            <div class="md:col-span-3 flex justify-end space-x-2">
                                <button type="button" id="cancelEditBtn" class="bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 hidden">Batal Edit</button>
                                <button type="submit" class="bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600">Simpan Menu</button>
                            </div>
                        </form>
                        <!-- Daftar Menu Penjual -->
                        <div id="penjualMenuList" class="space-y-3">
                            <!-- Daftar Menu akan di-render di sini -->
                        </div>
                    </div>

                    <!-- Tab Laporan -->
                    <div id="penjualReportView" class="penjual-tab-content hidden bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Laporan Penjualan Sederhana</h2>
                        <div id="penjualReportContent">
                            <p class="text-lg">Total Pendapatan (dari pesanan 'Selesai'): <span id="totalRevenue" class="font-bold text-green-700">Rp 0</span></p>
                            <h4 class="font-semibold mt-4 mb-2">Item Terjual:</h4>
                            <ul id="itemsSoldList" class="list-disc list-inside">
                                <!-- Daftar item terjual -->
                            </ul>
                        </div>
                    </div>
                </div>

            </main>
        </div>

    </div> <!-- Akhir #app -->

    <!-- Modal Notifikasi -->
    <div id="notificationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center fade-in">
            <p id="notificationMessage" class="text-lg text-gray-700"></p>
            <button id="closeNotificationBtn" class="mt-4 bg-blue-500 text-white py-2 px-6 rounded-lg font-medium hover:bg-blue-600">Tutup</button>
        </div>
    </div>


    <script type="module">
        // ========================================================================
        // DATABASE LOKAL (Disimpan dalam Memori JavaScript)
        // ========================================================================
        const appData = {
            currentUser: null,
            users: [
                { id: 'u1', username: 'ADMIN KANTIN', password: 'admin123', role: 'Admin' },
                { id: 'u2', username: 'buida', password: '123', role: 'Penjual', namaWarung: 'Kantin Bu Ida' },
                { id: 'u3', username: 'paktono', password: '123', role: 'Penjual', namaWarung: 'Warung Pak Tono' },
                { id: 'u4', username: 'siswa1', password: '123', role: 'Siswa', kelas: 'X A' }
            ],
            sellers: [
                { id: 's1', name: 'Kantin Bu Ida', userId: 'u2' },
                { id: 's2', name: 'Warung Pak Tono', userId: 'u3' }
            ], // { id: 's1', name: 'Kantin Bu Ida', userId: 'uX' }
            menus: [
                // Menu Bu Ida
                { id: 'm1', sellerId: 's1', name: 'Nasi Goreng', price: 12000, stock: 50, category: 'Makanan', image: 'https://placehold.co/150x150/D1FAE5/10B981?text=Nasi+Goreng' },
                { id: 'm2', sellerId: 's1', name: 'Mie Ayam', price: 10000, stock: 40, category: 'Makanan', image: 'https://placehold.co/150x150/D1FAE5/10B981?text=Mie+Ayam' },
                { id: 'm3', sellerId: 's1', name: 'Es Teh Manis', price: 3000, stock: 100, category: 'Minuman', image: 'https://placehold.co/150x150/D1FAE5/10B981?text=Es+Teh' },
                { id: 'm4', sellerId: 's1', name: 'Kerupuk', price: 1000, stock: 200, category: 'Snack', image: 'https://placehold.co/150x150/D1FAE5/10B981?text=Kerupuk' },
                { id: 'm9', sellerId: 's1', name: 'Nasi Uduk', price: 10000, stock: 30, category: 'Makanan', image: 'https://placehold.co/150x150/D1FAE5/10B981?text=Nasi+Uduk' },
                { id: 'm10', sellerId: 's1', name: 'Risol Mayo', price: 2500, stock: 50, category: 'Snack', image: 'https://placehold.co/150x150/D1FAE5/10B981?text=Risol' },
                { id: 'm11', sellerId: 's1', name: 'Aqua Botol 600ml', price: 3500, stock: 80, category: 'Minuman', image: 'https://placehold.co/150x150/D1FAE5/10B981?text=Aqua' },
                // Menu Pak Tono
                { id: 'm5', sellerId: 's2', name: 'Soto Ayam', price: 11000, stock: 30, category: 'Makanan', image: 'https://placehold.co/150x150/C2F7C2/4CAF50?text=Soto+Ayam' },
                { id: 'm6', sellerId: 's2', name: 'Es Jeruk', price: 4000, stock: 50, category: 'Minuman', image: 'https://placehold.co/150x150/C2F7C2/4CAF50?text=Es+Jeruk' },
                { id: 'm7', sellerId: 's2', name: 'Gorengan Bakwan', price: 1000, stock: 150, category: 'Snack', image: 'https://placehold.co/150x150/C2F7C2/4CAF50?text=Bakwan' },
                { id: 'm8', sellerId: 's2', name: 'Kopi Hitam', price: 3000, stock: 20, category: 'Minuman', image: 'https://placehold.co/150x150/C2F7C2/4CAF50?text=Kopi+Hitam' },
                { id: 'm12', sellerId: 's2', name: 'Siomay Komplit', price: 10000, stock: 35, category: 'Makanan', image: 'https://placehold.co/150x150/C2F7C2/4CAF50?text=Siomay' },
                { id: 'm13', sellerId: 's2', name: 'Bubur Ayam', price: 8000, stock: 25, category: 'Makanan', image: 'https://placehold.co/150x150/C2F7C2/4CAF50?text=Bubur+Ayam' },
                { id: 'm14', sellerId: 's2', name: 'Teh Kotak', price: 4000, stock: 60, category: 'Minuman', image: 'https://placehold.co/150x150/C2F7C2/4CAF50?text=Teh+Kotak' },
                { id: 'm15', sellerId: 's2', name: 'Keripik Kentang', price: 2000, stock: 70, category: 'Snack', image: 'https://placehold.co/150x150/C2F7C2/4CAF50?text=Keripik' }
            ],
            orders: [], // { id: 'o1', userId: 'uX', sellerId: 'sX', items: [{ menuId: 'm1', name: 'Nasi Goreng', quantity: 1, price: 12000 }], total: 12000, status: 'Diterima', orderTime: 'timestamp' }
            promos: [
                { id: 'p1', code: 'HEMATSIANG', description: 'Diskon 20% untuk semua Makanan', category: 'Makanan', discountPercent: 20, activeHours: '10:00-12:00' },
                { id: 'p2', code: 'MINUMSEGAR', description: 'Beli 2 Gratis 1 Es Teh', menuId: 'm2' /* (jika spesifik) */, activeHours: null }
            ],
            cart: [] // { menuId: 'm1', name: 'Nasi Goreng', price: 12000, quantity: 1, sellerId: 's1' }
        };

        // ========================================================================
        // UTILITY FUNCTIONS
        // ========================================================================

        // Fungsi untuk format mata uang
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        };

        // Fungsi untuk navigasi antar view
        const navigateTo = (viewId) => {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');
            window.scrollTo(0, 0); // Scroll ke atas
        };
        
        // Fungsi untuk navigasi tab internal (Siswa & Penjual)
        const navigateToTab = (buttonClass, contentClass, targetId) => {
            document.querySelectorAll(`.${contentClass}`).forEach(tab => tab.classList.add('hidden'));
            document.getElementById(targetId).classList.remove('hidden');
            
            document.querySelectorAll(`.${buttonClass}`).forEach(btn => {
                btn.classList.remove('bg-blue-100', 'text-blue-600');
                btn.classList.add('text-gray-600', 'hover:bg-gray-100');
            });
            document.querySelector(`.${buttonClass}[data-target="${targetId}"]`).classList.add('bg-blue-100', 'text-blue-600');
            document.querySelector(`.${buttonClass}[data-target="${targetId}"]`).classList.remove('text-gray-600', 'hover:bg-gray-100');
        };

        // Fungsi untuk menampilkan notifikasi modal
        const showNotification = (message) => {
            document.getElementById('notificationMessage').textContent = message;
            document.getElementById('notificationModal').classList.remove('hidden');
        };

        // Fungsi untuk membuat ID unik (sederhana)
        const generateId = (prefix) => `${prefix}${Date.now()}${Math.floor(Math.random() * 100)}`;

        // Fungsi untuk mengisi opsi kelas (pendaftaran siswa)
        const populateKelasOptions = () => {
            const select = document.getElementById('registerKelas');
            const tingkatan = ['X', 'XI', 'XII'];
            const jurusan = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L'];
            tingkatan.forEach(t => {
                jurusan.forEach(j => {
                    const option = document.createElement('option');
                    option.value = `${t} ${j}`;
                    option.textContent = `${t} ${j}`;
                    select.appendChild(option);
                });
            });
        };

        // ========================================================================
        // RENDER FUNCTIONS (Memperbarui UI berdasarkan appData)
        // ========================================================================

        // ADMIN Renders
        function renderAdminDashboard() {
            // Render daftar penjual
            const sellerList = document.getElementById('adminSellerList');
            sellerList.innerHTML = '';
            appData.sellers.forEach(seller => {
                const user = appData.users.find(u => u.id === seller.userId);
                sellerList.innerHTML += `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span><strong>${seller.name}</strong> (@${user ? user.username : 'N/A'})</span>
                        <button class="admin-delete-seller text-red-500 hover:text-red-700 text-sm" data-id="${seller.id}">Hapus</button>
                    </div>
                `;
            });

            // Render dropdown user untuk dijadikan penjual
            const userSelect = document.getElementById('adminSelectUser');
            userSelect.innerHTML = '<option value="">-- Pilih User --</option>';
            appData.users
                .filter(u => u.role === 'Penjual' && !appData.sellers.find(s => s.userId === u.id))
                .forEach(u => {
                    userSelect.innerHTML += `<option value="${u.id}">${u.namaWarung} (@${u.username})</option>`;
                });
            
            // Render rekap pesanan
            const orderList = document.getElementById('adminOrderList');
            orderList.innerHTML = '';
            if (appData.orders.length === 0) {
                orderList.innerHTML = '<p class="text-gray-500">Belum ada pesanan.</p>';
                // HAPUS 'return;' AGAR FUNGSI LANJUT KE RENDER MENU
            } else {
                appData.orders.slice().reverse().forEach(order => {
                    const seller = appData.sellers.find(s => s.id === order.sellerId);
                    orderList.innerHTML += `
                    <div class="p-3 border rounded-lg bg-white shadow-sm">
                        <p class="font-semibold">${order.items.map(i => `${i.name} (x${i.quantity})`).join(', ')}</p>
                        <p class="text-sm text-gray-600">Pemesan: ${user?.username || 'N/A'} | Penjual: ${seller?.name || 'N/A'}</p>
                        <p class="text-sm">Total: <span class="font-medium">${formatCurrency(order.total)}</span> | Status: <span class="font-semibold text-blue-600">${order.status}</span></p>
                    </div>
                `;
                });
            }

            renderAdminMenus(); // PANGGIL FUNGSI BARU (Sekarang pasti terpanggil)
        }

        // FUNGSI BARU UNTUK RENDER MENU ADMIN
        function renderAdminMenus() {
            const menuList = document.getElementById('adminMenuList');
            menuList.innerHTML = '';
            
            if (appData.menus.length === 0) {
                menuList.innerHTML = '<p class="text-gray-500">Belum ada menu di sistem.</p>';
                return;
            }

            // Urutkan berdasarkan sellerId agar mengelompok (Gunakan [...appData.menus] agar tidak mengubah array asli)
            const sortedMenus = [...appData.menus].sort((a, b) => a.sellerId.localeCompare(b.sellerId));

            sortedMenus.forEach(menu => {
                const seller = appData.sellers.find(s => s.id === menu.sellerId);
                const sellerName = seller ? seller.name : 'Penjual Dihapus';
                
                menuList.innerHTML += `
                    <div class="flex justify-between items-center p-3 border rounded-lg bg-gray-50">
                        <div>
                            <p class="font-semibold">${menu.name} (${menu.category})</p>
                            <p class="text-sm text-gray-600">Oleh: <span class="font-medium">${sellerName}</span></p>
                            <p class="text-sm text-gray-600">${formatCurrency(menu.price)} - Stok: ${menu.stock}</p>
                        </div>
                        <div class="space-x-2">
                            <button class="admin-delete-menu bg-red-500 text-white py-1 px-3 rounded text-sm hover:bg-red-600" data-id="${menu.id}">Hapus</button>
                        </div>
                    </div>
                `;
            });
        }

        // PENJUAL Renders
        function renderPenjualDashboard() {
            if (!appData.currentUser || appData.currentUser.role !== 'Penjual') return;
            const mySellerProfile = appData.sellers.find(s => s.userId === appData.currentUser.id);
            if (!mySellerProfile) {
                document.getElementById('penjualOrderView').innerHTML = '<p class="text-red-500">Akun Anda belum dikonfirmasi sebagai penjual oleh Admin.</p>';
                document.getElementById('penjualMenuView').classList.add('hidden');
                document.getElementById('penjualReportView').classList.add('hidden');
                return;
            }
            
            const sellerId = mySellerProfile.id;
            renderPenjualMenu(sellerId);
            renderPenjualOrders(sellerId);
            renderPenjualReport(sellerId);
        }

        function renderPenjualMenu(sellerId) {
            const menuList = document.getElementById('penjualMenuList');
            menuList.innerHTML = '';
            const myMenus = appData.menus.filter(m => m.sellerId === sellerId);
            
            if (myMenus.length === 0) {
                menuList.innerHTML = '<p class="text-gray-500">Anda belum memiliki menu. Silakan tambahkan.</p>';
                return;
            }

            myMenus.forEach(menu => {
                menuList.innerHTML += `
                    <div class="flex justify-between items-center p-3 border rounded-lg">
                        <div>
                            <p class="font-semibold">${menu.name} (${menu.category})</p>
                            <p class="text-sm text-gray-600">${formatCurrency(menu.price)} - Stok: ${menu.stock}</p>
                        </div>
                        <div class="space-x-2">
                            <button class="penjual-edit-menu bg-yellow-400 text-white py-1 px-3 rounded text-sm hover:bg-yellow-500" data-id="${menu.id}">Edit</button>
                            <button class="penjual-delete-menu bg-red-500 text-white py-1 px-3 rounded text-sm hover:bg-red-600" data-id="${menu.id}">Hapus</button>
                        </div>
                    </div>
                `;
            });
        }
        
        function renderPenjualOrders(sellerId) {
            const orderList = document.getElementById('penjualOrderList');
            orderList.innerHTML = '';
            const myOrders = appData.orders.filter(o => o.sellerId === sellerId).slice().reverse();

            if (myOrders.length === 0) {
                orderList.innerHTML = '<p class="text-gray-500">Belum ada pesanan masuk.</p>';
                return;
            }

            myOrders.forEach(order => {
                const user = appData.users.find(u => u.id === order.userId);
                orderList.innerHTML += `
                    <div class="p-4 border rounded-lg bg-gray-50 shadow-sm">
                        <p class="text-sm text-gray-500">Pesanan dari: ${user?.username || 'N/A'} (${user?.kelas || 'Guru'})</p>
                        <ul class="list-disc list-inside my-2 ml-4">
                            ${order.items.map(item => `<li>${item.name} (x${item.quantity})</li>`).join('')}
                        </ul>
                        <p class="font-semibold">Total: ${formatCurrency(order.total)}</p>
                        <div class="flex items-center space-x-2 mt-3">
                            <label class="text-sm font-medium">Status:</label>
                            <select class="penjual-status-select bg-white border rounded p-1" data-order-id="${order.id}" ${order.status === 'Selesai' ? 'disabled' : ''}>
                                <option value="Diterima" ${order.status === 'Diterima' ? 'selected' : ''}>Diterima</option>
                                <option value="Diproses" ${order.status === 'Diproses' ? 'selected' : ''}>Diproses</option>
                                <option value="Siap Diambil" ${order.status === 'Siap Diambil' ? 'selected' : ''}>Siap Diambil</option>
                                <option value="Selesai" ${order.status === 'Selesai' ? 'selected' : ''}>Selesai</option>
                            </select>
                        </div>
                    </div>
                `;
            });
        }
        
        function renderPenjualReport(sellerId) {
            const finishedOrders = appData.orders.filter(o => o.sellerId === sellerId && o.status === 'Selesai');
            
            const totalRevenue = finishedOrders.reduce((sum, order) => sum + order.total, 0);
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);

            const itemsSold = {};
            finishedOrders.forEach(order => {
                order.items.forEach(item => {
                    itemsSold[item.name] = (itemsSold[item.name] || 0) + item.quantity;
                });
            });

            const itemsSoldList = document.getElementById('itemsSoldList');
            itemsSoldList.innerHTML = '';
            if (Object.keys(itemsSold).length === 0) {
                itemsSoldList.innerHTML = '<li>Belum ada item terjual.</li>';
                return;
            }
            for (const itemName in itemsSold) {
                itemsSoldList.innerHTML += `<li>${itemName}: ${itemsSold[itemName]} terjual</li>`;
            }
        }

        // SISWA Renders
        function renderSiswaDashboard(activeFilter = "Semua") {
            // Render Menu
            const menuList = document.getElementById('siswaMenuList');
            menuList.innerHTML = '';
            
            const filteredMenus = activeFilter === 'Semua' 
                ? appData.menus 
                : appData.menus.filter(m => m.category === activeFilter);
            
            if (filteredMenus.length === 0) {
                menuList.innerHTML = '<p class="text-gray-500 col-span-full">Menu tidak tersedia.</p>';
                return;
            }

            filteredMenus.forEach(menu => {
                const seller = appData.sellers.find(s => s.id === menu.sellerId);
                const outOfStock = menu.stock <= 0;
                menuList.innerHTML += `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden ${outOfStock ? 'opacity-50' : ''}">
                        <img src="https://placehold.co/300x200/${outOfStock ? 'E0E0E0' : 'D1FAE5'}/${outOfStock ? '9E9E9E' : '10B981'}?text=${encodeURIComponent(menu.name)}" alt="${menu.name}" class="w-full h-32 object-cover">
                        <div class="p-4">
                            <h4 class="font-semibold text-lg">${menu.name}</h4>
                            <p class="text-sm text-gray-500 mb-2">${seller?.name || 'Kantin'}</p>
                            <p class="font-bold text-green-600 text-lg">${formatCurrency(menu.price)}</p>
                            <p class="text-sm text-gray-500 mb-3">Stok: ${menu.stock}</p>
                            <button 
                                class="add-to-cart-btn w-full bg-blue-500 text-white py-2 rounded-lg font-medium hover:bg-blue-600 transition ${outOfStock ? 'bg-gray-400 cursor-not-allowed' : ''}" 
                                data-id="${menu.id}" ${outOfStock ? 'disabled' : ''}>
                                ${outOfStock ? 'Stok Habis' : '+ Keranjang'}
                            </button>
                        </div>
                    </div>
                `;
            });

            // Update tombol filter
            document.querySelectorAll('.menu-filter-btn').forEach(btn => {
                btn.classList.toggle('bg-green-500', btn.dataset.category === activeFilter);
                btn.classList.toggle('text-white', btn.dataset.category === activeFilter);
                btn.classList.toggle('bg-gray-200', btn.dataset.category !== activeFilter);
                btn.classList.toggle('text-gray-700', btn.dataset.category !== activeFilter);
            });
            
            renderCart();
            renderSiswaOrderHistory();
            renderSiswaPromo();
        }
        
        // GURU Renders (disederhanakan, memanggil fungsi render Siswa)
        function renderGuruDashboard(activeFilter = "Semua") { // TAMBAHKAN activeFilter
            const menuList = document.getElementById('guruMenuList');
            menuList.innerHTML = '';
            
            // LOGIKA FILTER BARU UNTUK GURU
            const filteredMenus = activeFilter === 'Semua' 
                ? appData.menus 
                : appData.menus.filter(m => m.category === activeFilter);
            
            if (filteredMenus.length === 0) {
                menuList.innerHTML = '<p class="text-gray-500 col-span-full">Menu tidak tersedia.</p>';
            } else {
                // GUNAKAN filteredMenus
                filteredMenus.forEach(menu => {
                    const seller = appData.sellers.find(s => s.id === menu.sellerId);
                    const outOfStock = menu.stock <= 0;
                    menuList.innerHTML += `
                        <div class="bg-white rounded-lg shadow-md overflow-hidden ${outOfStock ? 'opacity-50' : ''}">
                            <p class="font-bold text-green-600 text-lg">${formatCurrency(menu.price)}</p>
                            <p class="text-sm text-gray-500 mb-3">Stok: ${menu.stock}</p>
                            <button 
                                class="add-to-cart-btn w-full bg-blue-500 text-white py-2 rounded-lg font-medium hover:bg-blue-600 transition ${outOfStock ? 'bg-gray-400 cursor-not-allowed' : ''}" 
                                data-id="${menu.id}" ${outOfStock ? 'disabled' : ''}>
                                ${outOfStock ? 'Stok Habis' : '+ Keranjang'}
                            </button>
                        </div>
                    </div>
                `;
                });
            }
            
            // UPDATE TOMBOL FILTER GURU (BARU)
            document.querySelectorAll('.guru-menu-filter-btn').forEach(btn => {
                btn.classList.toggle('bg-green-500', btn.dataset.category === activeFilter);
                btn.classList.toggle('text-white', btn.dataset.category === activeFilter);
                btn.classList.toggle('bg-gray-200', btn.dataset.category !== activeFilter);
                btn.classList.toggle('text-gray-700', btn.dataset.category !== activeFilter);
            });

            renderCart(); // Memanggil renderCart untuk guru juga
            renderGuruOrderHistory();
        }

        // Render Promo
        function renderSiswaPromo() {
            const promoList = document.getElementById('siswaPromoList');
            promoList.innerHTML = '';
            const now = new Date();
            const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            appData.promos.forEach(promo => {
                let disclaimer = '';
                let active = true;
                if (promo.activeHours) {
                    const [start, end] = promo.activeHours.split('-');
                    if (currentTime < start || currentTime > end) {
                        disclaimer = `<p class="text-sm text-red-500 font-medium">Promo hanya berlaku jam ${promo.activeHours}</p>`;
                        active = false;
                    } else {
                        disclaimer = `<p class="text-sm text-green-600 font-medium">Promo aktif sampai jam ${end}!</p>`;
                    }
                }
                
                promoList.innerHTML += `
                    <div class="border rounded-lg p-4 ${active ? 'bg-green-50' : 'bg-gray-100 opacity-70'}">
                        <h4 class="font-semibold text-lg ${active ? 'text-green-800' : 'text-gray-700'}">${promo.description}</h4>
                        ${disclaimer}
                        <button class="promo-btn mt-2 bg-green-500 text-white py-1 px-3 rounded text-sm hover:bg-green-600 ${!active ? 'bg-gray-400 cursor-not-allowed' : ''}" 
                                data-code="${promo.code}" ${!active ? 'disabled' : ''}>
                            Gunakan Promo
                        </button>
                    </div>
                `;
            });
        }
        
        // Render Keranjang (digunakan Siswa & Guru)
        function renderCart() {
            const role = appData.currentUser.role;
            const cartListId = role === 'Siswa' ? 'cartItemsList' : 'guruCartItemsList';
            const cartTotalId = role === 'Siswa' ? 'cartTotal' : 'guruCartTotal';
            const cartCountId = role === 'Siswa' ? 'cartCount' : 'guruCartCount';
            
            const cartList = document.getElementById(cartListId);
            cartList.innerHTML = '';
            
            if (appData.cart.length === 0) {
                cartList.innerHTML = '<p class="text-gray-500">Keranjang masih kosong.</p>';
            }

            let total = 0;
            appData.cart.forEach(item => {
                total += item.price * item.quantity;
                cartList.innerHTML += `
                    <div class="flex justify-between items-center p-2 border-b">
                        <div>
                            <p class="font-semibold">${item.name}</p>
                            <p class="text-sm text-gray-600">${formatCurrency(item.price)} x ${item.quantity}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                             <button class="cart-update-btn bg-gray-200 w-6 h-6 rounded-full" data-id="${item.menuId}" data-action="decrease">-</button>
                             <span>${item.quantity}</span>
                             <button class="cart-update-btn bg-gray-200 w-6 h-6 rounded-full" data-id="${item.menuId}" data-action="increase">+</button>
                             <button class="cart-remove-btn text-red-500 hover:text-red-700 ml-2" data-id="${item.menuId}">&times;</button>
                        </div>
                    </div>
                `;
            });

            document.getElementById(cartTotalId).textContent = formatCurrency(total);
            document.getElementById(cartCountId).textContent = appData.cart.reduce((sum, item) => sum + item.quantity, 0);
        }

        // Render Riwayat Pesanan
        function renderSiswaOrderHistory() {
            const historyContainer = document.getElementById('siswaOrderHistory');
            historyContainer.innerHTML = '';
            const myOrders = appData.orders.filter(o => o.userId === appData.currentUser.id).slice().reverse();

            if (myOrders.length === 0) {
                historyContainer.innerHTML = '<p class="text-gray-500">Anda belum pernah memesan.</p>';
                return;
            }
            
            myOrders.forEach(order => {
                const seller = appData.sellers.find(s => s.id === order.sellerId);
                historyContainer.innerHTML += `
                    <div class="p-4 border rounded-lg bg-gray-50 shadow-sm">
                        <p class="font-semibold">Pesanan di ${seller?.name || 'Kantin'}</p>
                        <ul class="list-disc list-inside my-2 ml-4 text-sm">
                            ${order.items.map(item => `<li>${item.name} (x${item.quantity})</li>`).join('')}
                        </ul>
                        <p class="font-medium">Total: ${formatCurrency(order.total)}</p>
                        <p class="font-semibold mt-1">Status: <span class="text-green-700">${order.status}</span></p>
                    </div>
                `;
            });
        }
        
        function renderGuruOrderHistory() {
            const historyContainer = document.getElementById('guruOrderHistory');
            historyContainer.innerHTML = '';
            const myOrders = appData.orders.filter(o => o.userId === appData.currentUser.id).slice().reverse();

            if (myOrders.length === 0) {
                historyContainer.innerHTML = '<p class="text-gray-500">Anda belum pernah membeli.</p>';
                return;
            }
            
            myOrders.forEach(order => {
                const seller = appData.sellers.find(s => s.id === order.sellerId);
                historyContainer.innerHTML += `
                    <div class="p-4 border rounded-lg bg-gray-50 shadow-sm">
                        <p class="font-semibold">Pembelian di ${seller?.name || 'Kantin'}</p>
                        <ul class="list-disc list-inside my-2 ml-4 text-sm">
                            ${order.items.map(item => `<li>${item.name} (x${item.quantity})</li>`).join('')}
                        </ul>
                        <p class="font-medium">Total: ${formatCurrency(order.total)}</p>
                        <p class="font-semibold mt-1">Status: <span class="text-green-700">${order.status}</span></p>
                    </div>
                `;
            });
        }


        // ========================================================================
        // EVENT HANDLERS
        // ========================================================================

        // Handler Navigasi Login/Register
        document.getElementById('showRegisterBtn').addEventListener('click', () => navigateTo('registerView'));
        document.getElementById('showLoginBtn').addEventListener('click', () => navigateTo('loginView'));
        document.getElementById('registerRole').addEventListener('change', (e) => {
            document.getElementById('siswaFields').classList.toggle('hidden', e.target.value !== 'Siswa');
            document.getElementById('penjualFields').classList.toggle('hidden', e.target.value !== 'Penjual');
        });

        // Handler Notifikasi
        document.getElementById('closeNotificationBtn').addEventListener('click', () => {
            document.getElementById('notificationModal').classList.add('hidden');
        });

        // Handler Login
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const role = document.getElementById('loginRole').value;
            const errorEl = document.getElementById('loginError');

            const user = appData.users.find(u => u.username === username && u.password === password && u.role === role);

            if (user) {
                appData.currentUser = user;
                document.getElementById('currentUserName').textContent = user.username;
                navigateTo('dashboardWrapper');
                
                // Tampilkan dashboard yang sesuai
                document.querySelectorAll('.dashboard-panel').forEach(panel => panel.classList.add('hidden'));
                if (role === 'Admin') {
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    renderAdminDashboard();
                } else if (role === 'Siswa') {
                    document.getElementById('siswaDashboard').classList.remove('hidden');
                    renderSiswaDashboard();
                    navigateToTab('siswa-nav-btn', 'siswa-tab-content', 'siswaMenuView');
                } else if (role === 'Guru') {
                    document.getElementById('guruDashboard').classList.remove('hidden');
                    renderGuruDashboard();
                    navigateToTab('guru-nav-btn', 'guru-tab-content', 'guruMenuView');
                } else if (role === 'Penjual') {
                    document.getElementById('penjualDashboard').classList.remove('hidden');
                    renderPenjualDashboard();
                    navigateToTab('penjual-nav-btn', 'penjual-tab-content', 'penjualOrderView');
                }
                
                errorEl.classList.add('hidden');
                document.getElementById('loginForm').reset();
            } else {
                errorEl.textContent = 'Username, password, atau peran salah.';
                errorEl.classList.remove('hidden');
            }
        });

        // Handler Register
        document.getElementById('registerForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const role = document.getElementById('registerRole').value;
            const errorEl = document.getElementById('registerError');

            if (appData.users.find(u => u.username === username)) {
                errorEl.textContent = 'Username sudah digunakan.';
                errorEl.classList.remove('hidden');
                return;
            }

            const newUser = {
                id: generateId('u'),
                username,
                password,
                role
            };

            if (role === 'Siswa') {
                newUser.kelas = document.getElementById('registerKelas').value;
            } else if (role === 'Penjual') {
                const namaWarung = document.getElementById('registerNamaWarung').value;
                if (!namaWarung) {
                    errorEl.textContent = 'Nama warung wajib diisi untuk penjual.';
                    errorEl.classList.remove('hidden');
                    return;
                }
                newUser.namaWarung = namaWarung;
            }

            appData.users.push(newUser);
            showNotification('Pendaftaran berhasil! Silakan login.');
            navigateTo('loginView');
            document.getElementById('registerForm').reset();
            errorEl.classList.add('hidden');
        });

        // Handler Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            appData.currentUser = null;
            appData.cart = []; // Kosongkan keranjang saat logout
            navigateTo('loginView');
        });
        
        // Event Delegation untuk tombol dinamis
        document.getElementById('app').addEventListener('click', (e) => {
            // -- Navigasi Tab --
            if (e.target.closest('.siswa-nav-btn')) {
                navigateToTab('siswa-nav-btn', 'siswa-tab-content', e.target.closest('.siswa-nav-btn').dataset.target);
            }
            if (e.target.closest('.guru-nav-btn')) {
                navigateToTab('guru-nav-btn', 'guru-tab-content', e.target.closest('.guru-nav-btn').dataset.target);
            }
            if (e.target.closest('.penjual-nav-btn')) {
                // panggil ulang render saat pindah tab untuk data terbaru
                if(appData.currentUser.role === 'Penjual') renderPenjualDashboard(); 
                navigateToTab('penjual-nav-btn', 'penjual-tab-content', e.target.closest('.penjual-nav-btn').dataset.target);
            }
            
            // -- Admin --
            if (e.target.classList.contains('admin-delete-seller')) {
                const sellerId = e.target.dataset.id;
                // Hapus penjual & menu terkait
                appData.sellers = appData.sellers.filter(s => s.id !== sellerId);
                appData.menus = appData.menus.filter(m => m.sellerId !== sellerId);
                renderAdminDashboard();
                showNotification('Penjual dan semua menunya telah dihapus.');
            }

            // BARU: Admin Hapus Menu
            if (e.target.classList.contains('admin-delete-menu')) {
                const menuId = e.target.dataset.id;
                appData.menus = appData.menus.filter(m => m.id !== menuId);
                renderAdminMenus(); // Render ulang daftar menu admin
                showNotification('Menu telah dihapus.');
            }
            
            // -- Siswa: Filter Menu --
            if (e.target.closest('.menu-filter-btn')) {
                renderSiswaDashboard(e.target.closest('.menu-filter-btn').dataset.category);
            }

            // BARU: Guru: Filter Menu
            if (e.target.closest('.guru-menu-filter-btn')) {
                renderGuruDashboard(e.target.closest('.guru-menu-filter-btn').dataset.category);
            }

            // -- Siswa/Guru: Keranjang --
            if (e.target.closest('.add-to-cart-btn')) {
                const menuId = e.target.closest('.add-to-cart-btn').dataset.id;
                const menu = appData.menus.find(m => m.id === menuId);
                
                if (menu.stock <= 0) {
                     showNotification('Stok menu ini habis.');
                     return;
                }

                const cartItem = appData.cart.find(item => item.menuId === menuId);
                if (cartItem) {
                    if(cartItem.quantity < menu.stock) {
                        cartItem.quantity++;
                    } else {
                        showNotification('Stok tidak mencukupi.');
                        return;
                    }
                } else {
                    appData.cart.push({
                        menuId: menu.id,
                        name: menu.name,
                        price: menu.price,
                        quantity: 1,
                        sellerId: menu.sellerId
                    });
                }
                renderCart();
                showNotification(`${menu.name} ditambahkan ke keranjang.`);
            }
            
            if (e.target.closest('.cart-update-btn')) {
                const btn = e.target.closest('.cart-update-btn');
                const menuId = btn.dataset.id;
                const action = btn.dataset.action;
                const cartItem = appData.cart.find(item => item.menuId === menuId);
                const menu = appData.menus.find(m => m.id === menuId);

                if (action === 'increase') {
                     if(cartItem.quantity < menu.stock) {
                        cartItem.quantity++;
                    } else {
                        showNotification('Stok tidak mencukupi.');
                        return;
                    }
                } else if (action === 'decrease') {
                    cartItem.quantity--;
                    if (cartItem.quantity === 0) {
                        appData.cart = appData.cart.filter(item => item.menuId !== menuId);
                    }
                }
                renderCart();
            }
            
            if (e.target.closest('.cart-remove-btn')) {
                const menuId = e.target.closest('.cart-remove-btn').dataset.id;
                appData.cart = appData.cart.filter(item => item.menuId !== menuId);
                renderCart();
            }

            // -- Penjual: Kelola Menu --
            if (e.target.classList.contains('penjual-edit-menu')) {
                const menuId = e.target.dataset.id;
                const menu = appData.menus.find(m => m.id === menuId);
                document.getElementById('menuId').value = menu.id;
                document.getElementById('menuName').value = menu.name;
                document.getElementById('menuPrice').value = menu.price;
                document.getElementById('menuStock').value = menu.stock;
                document.getElementById('menuCategory').value = menu.category;
                document.getElementById('cancelEditBtn').classList.remove('hidden');
                document.getElementById('menuForm').scrollIntoView();
            }
            
            if (e.target.classList.contains('penjual-delete-menu')) {
                const menuId = e.target.dataset.id;
                appData.menus = appData.menus.filter(m => m.id !== menuId);
                const sellerId = appData.sellers.find(s => s.userId === appData.currentUser.id).id;
                renderPenjualMenu(sellerId);
                showNotification('Menu berhasil dihapus.');
            }
        });

        // Handler Admin: Tambah Penjual
        document.getElementById('adminAddSellerForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const userId = document.getElementById('adminSelectUser').value;
            if (!userId) return;
            
            const user = appData.users.find(u => u.id === userId);
            const newSeller = {
                id: generateId('s'),
                name: user.namaWarung,
                userId: user.id
            };
            appData.sellers.push(newSeller);
            renderAdminDashboard();
            showNotification(`${user.namaWarung} berhasil ditambahkan sebagai penjual.`);
        });
        
        // Handler Penjual: Tambah/Edit Menu
        document.getElementById('menuForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const sellerId = appData.sellers.find(s => s.userId === appData.currentUser.id).id;
            const menuId = document.getElementById('menuId').value;
            const menuData = {
                name: document.getElementById('menuName').value,
                price: parseInt(document.getElementById('menuPrice').value),
                stock: parseInt(document.getElementById('menuStock').value),
                category: document.getElementById('menuCategory').value,
                sellerId: sellerId,
                image: `https://placehold.co/150x150/D1FAE5/10B981?text=${encodeURIComponent(document.getElementById('menuName').value)}`
            };

            if (menuId) { // Edit
                const index = appData.menus.findIndex(m => m.id === menuId);
                appData.menus[index] = { ...appData.menus[index], ...menuData };
                showNotification('Menu berhasil diperbarui.');
            } else { // Tambah
                appData.menus.push({ id: generateId('m'), ...menuData });
                showNotification('Menu berhasil ditambahkan.');
            }
            
            renderPenjualMenu(sellerId);
            document.getElementById('menuForm').reset();
            document.getElementById('menuId').value = '';
            document.getElementById('cancelEditBtn').classList.add('hidden');
        });
        
        document.getElementById('cancelEditBtn').addEventListener('click', () => {
            document.getElementById('menuForm').reset();
            document.getElementById('menuId').value = '';
            document.getElementById('cancelEditBtn').classList.add('hidden');
        });

        // Handler Penjual: Ubah Status Pesanan
        document.getElementById('app').addEventListener('change', (e) => {
            if (e.target.classList.contains('penjual-status-select')) {
                const orderId = e.target.dataset.orderId;
                const newStatus = e.target.value;
                const order = appData.orders.find(o => o.id === orderId);
                order.status = newStatus;
                showNotification(`Status pesanan ${orderId} diubah menjadi ${newStatus}.`);
                // Jika sudah selesai, tidak bisa diubah lagi
                if (newStatus === 'Selesai') {
                    e.target.disabled = true;
                    // Render ulang tab laporan untuk update pendapatan
                    const sellerId = appData.sellers.find(s => s.userId === appData.currentUser.id).id;
                    renderPenjualReport(sellerId);
                }
            }
        });

        // Handler Checkout (Siswa & Guru)
        const handleCheckout = () => {
            if (appData.cart.length === 0) {
                showNotification('Keranjang Anda kosong.');
                return;
            }

            // Pisahkan pesanan berdasarkan sellerId
            const ordersBySeller = {};
            appData.cart.forEach(item => {
                if (!ordersBySeller[item.sellerId]) {
                    ordersBySeller[item.sellerId] = {
                        items: [],
                        total: 0
                    };
                }
                ordersBySeller[item.sellerId].items.push({
                    menuId: item.menuId,
                    name: item.name,
                    quantity: item.quantity,
                    price: item.price
                });
                ordersBySeller[item.sellerId].total += item.price * item.quantity;
            });

            // Buat pesanan terpisah untuk setiap penjual
            for (const sellerId in ordersBySeller) {
                const orderData = ordersBySeller[sellerId];
                
                // Cek stok sebelum membuat pesanan
                let stockSufficient = true;
                orderData.items.forEach(item => {
                   const menu = appData.menus.find(m => m.id === item.menuId);
                   if (menu.stock < item.quantity) {
                       stockSufficient = false;
                       showNotification(`Stok ${menu.name} tidak mencukupi (sisa ${menu.stock}). Pesanan dibatalkan.`);
                   }
                });
                
                if (!stockSufficient) {
                    return; // Hentikan proses checkout jika ada stok yg kurang
                }

                // Kurangi stok
                orderData.items.forEach(item => {
                   const menu = appData.menus.find(m => m.id === item.menuId);
                   menu.stock -= item.quantity;
                });

                // Buat pesanan baru
                const newOrder = {
                    id: generateId('o'),
                    userId: appData.currentUser.id,
                    sellerId: sellerId,
                    items: orderData.items,
                    total: orderData.total,
                    status: 'Diterima',
                    orderTime: new Date().toISOString()
                };
                appData.orders.push(newOrder);
            }

            appData.cart = [];
            showNotification('Checkout berhasil! Pesanan Anda sedang diproses.');
            
            // Render ulang dan pindah ke riwayat pesanan
            if (appData.currentUser.role === 'Siswa') {
                renderSiswaDashboard();
                navigateToTab('siswa-nav-btn', 'siswa-tab-content', 'siswaHistoryView');
            } else {
                renderGuruDashboard();
                navigateToTab('guru-nav-btn', 'guru-tab-content', 'guruHistoryView');
            }
        };
        
        document.getElementById('checkoutBtn').addEventListener('click', handleCheckout);
        document.getElementById('guruCheckoutBtn').addEventListener('click', handleCheckout);


        // ========================================================================
        // INISIALISASI APLIKASI
        // ========================================================================
        window.onload = () => {
            populateKelasOptions();
            navigateTo('loginView'); // Mulai dari halaman login
        };
    </script>

</body>
</html>
